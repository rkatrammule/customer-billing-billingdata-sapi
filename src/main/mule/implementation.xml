<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:att-mule-applicationlogger="http://www.mulesoft.org/schema/mule/att-mule-applicationlogger"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/att-mule-applicationlogger http://www.mulesoft.org/schema/mule/att-mule-applicationlogger/current/mule-att-mule-applicationlogger.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">

	<sub-flow name="retrieve-billing-history-sub-flow"
		doc:id="672e9f18-6695-4501-9f3a-c9634d9b9666">
		<att-mule-applicationlogger:log-message
			doc:name="log-start" doc:id="0a54fb36-a1a5-4c77-b996-f314d6316e9c"
			config-ref="ATT_Mule_Application_Logger_Config"
			message="Start of flow retrieve-billing-history-sub-flow"
			method="#[vars.logHeaders.method]" reqHeaders="#[attributes.headers]"
			uri="#[vars.logHeaders.uri]"
			reqPayload='#[write({"ban" :attributes.uriParams.ban , "billerId" : attributes.uriParams.billerId},"application/json") as String]' />
		<ee:transform
			xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
			doc:name="uri param variables">
			<ee:variables>
				<ee:set-variable variableName="ban"><![CDATA[attributes.uriParams.'ban' default ""
				]]></ee:set-variable>
				<ee:set-variable variableName="billerId"><![CDATA[attributes.uriParams.'billerId' default ""
				]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<ee:transform doc:name="setting headers to system call"
			doc:id="5d8aabb9-0c86-4aa5-837b-4de91c613831">
			<ee:variables>
				<ee:set-variable variableName="billingHeader"><![CDATA[%dw 2.0
output application/json
---
{
	idpctxHeaders : if(vars.billerId =='TLG')  
					{
	"Authorization":"Basic bTIzOTgwQGlkcC5hdHQuY29tOmlkcEs4c3J2Y3NBdXRobnAhIQ==",
	"Accept": "application/json",
	"Content-Type": "application/json",
	"Idpctx-linkedwirelessaccnums": vars.ban
}
				else if(vars.billerId =='ENBLR')  
				{
	"Authorization":"Basic bTIzOTgwQGlkcC5hdHQuY29tOmlkcEs4c3J2Y3NBdXRobnAhIQ==",
	"Accept": "application/json",
	"Content-Type": "application/json",
	"Idpctx-linkeduverseaccnums": vars.ban
}
				else ''
}]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<http:request method="GET"
			doc:name="billing history request"
			doc:id="7dee90a5-348c-4845-b382-b9c4129abbb0"
			config-ref="HTTPS_Billing_MicroService_Request_config"
			path="${secure::billingMicroservice.http.billCycleHistoryPath}">
			<http:headers><![CDATA[#[vars.billingHeader.idpctxHeaders]]]></http:headers>
			<http:uri-params><![CDATA[#[%dw 2.0
output application/json
---
{
	"biller" : vars.billerId,
	"ban" : vars.ban
}]]]></http:uri-params>
		</http:request>
		<att-mule-applicationlogger:log-message
			doc:name="log-end" doc:id="55c253e2-6a9b-4015-ad07-d31f61476f05"
			config-ref="ATT_Mule_Application_Logger_Config"
			message="End of flow retrieve-billing-history-sub-flow"
			method="#[vars.logHeaders.method]" uri="#[vars.logHeaders.uri]"/>
	</sub-flow>

	<sub-flow name="get-statement-details-sub-flow"
		doc:id="7edc5e5c-a7bf-4ae9-b5ea-1921bcb910c4">
		<att-mule-applicationlogger:log-message
			doc:name="log-start" doc:id="5d85609f-5bb3-48d0-b43d-3eb572a89546"
			config-ref="ATT_Mule_Application_Logger_Config"
			message="Start of flow get-statement-details-sub-flow"
			method="#[vars.logHeaders.method]" reqHeaders="#[attributes.headers]"
			uri="#[vars.logHeaders.uri]"
			reqPayload='#[write({"statementId" :attributes.uriParams.statementId},"application/json") as String]' />
		<ee:transform doc:name="Transform Message"
			doc:id="d0c71325-9014-4d95-8c3f-16950974411d">
			<ee:variables>
				<ee:set-variable variableName="statementId">attributes.uriParams.'statementId'
				</ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="set-bill-details-headers-sub-flow"
			doc:id="b663565d-4c3e-41b4-be56-75d3d5fa9da2"
			name="set-bill-details-headers-sub-flow" />
		<http:request method="GET"
			doc:name="Bill Details Request"
			doc:id="135d22a9-44b9-40ed-a0dc-b3141671cae8"
			config-ref="HTTPS_Billing_MicroService_Request_config"
			path="${secure::billingMicroservice.http.billDetailsPath}">
			<http:headers><![CDATA[#[vars.billingHeader.idpctxHeaders]]]></http:headers>
			<http:uri-params><![CDATA[#[output application/java
---
{
	"statementID" : vars.statementId
}]]]></http:uri-params>
		</http:request>
		<att-mule-applicationlogger:log-message
			doc:name="log-end" doc:id="2c62a3ec-5211-4372-9f57-6a507fb16b6c"
			config-ref="ATT_Mule_Application_Logger_Config"
			message="End of flow get-statement-details-sub-flow"
			method="#[vars.logHeaders.method]" uri="#[vars.logHeaders.uri]"/>
	</sub-flow>
	<sub-flow name="get-statement-pdf-sub-flow"
		doc:id="79579642-c02b-4559-a37d-a575825b2d0a">
		<att-mule-applicationlogger:log-message
			doc:name="log-start" doc:id="0c64b05a-0b9d-4a70-abf0-7579082c25c7"
			config-ref="ATT_Mule_Application_Logger_Config"
			message="Start of flow get-statement-pdf-sub-flow"
			method="#[vars.logHeaders.method]" reqHeaders="#[attributes.headers]"
			uri="#[vars.logHeaders.uri]"
			reqPayload='#[write({"statementId" :attributes.uriParams.statementId},"application/json") as String]' />
		<ee:transform
			xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core">
			<ee:variables>
				<ee:set-variable variableName="statementId">attributes.uriParams.'statementId'
				</ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="set-bill-details-headers-sub-flow"
			doc:id="2c022975-827b-4fc8-96f6-bdb7d1552d50"
			name="set-bill-details-headers-sub-flow" />
		<http:request method="GET" doc:name="Bill PDF Request"
			doc:id="4ba7116a-468c-4381-b9d7-5b7074a3d720"
			config-ref="HTTPS_Billing_MicroService_Request_config"
			path="${secure::billingMicroservice.http.billPdfPath}">
			<http:headers><![CDATA[#[vars.billingHeader.idpctxHeaders]]]></http:headers>
			<http:uri-params><![CDATA[#[output application/java
---
{
	"statementID" : vars.statementId
}]]]></http:uri-params>
		</http:request>
		<att-mule-applicationlogger:log-message
			doc:name="log-end" doc:id="11926ec2-9e7a-4f7f-9bf1-c70df6099387"
			config-ref="ATT_Mule_Application_Logger_Config"
			message="End of flow get-statement-pdf-sub-flow"
			method="#[vars.logHeaders.method]" uri="#[vars.logHeaders.uri]"/>
	</sub-flow>
	<sub-flow name="set-bill-details-headers-sub-flow" doc:id="26f81525-9793-4b94-a36c-bd92e5a5afe5">
		<set-variable value="#[splitBy(vars.statementId,'-')[2]]" doc:name="billerId" doc:id="4415e0d1-8539-4315-9330-e72c1d1abc15" variableName="billerId" />
		<set-variable value="#[splitBy(vars.statementId,'-')[1]]" doc:name="ban" doc:id="3ca57c37-c7f3-400d-acbf-1a0e789b5a51" variableName="ban" />
		<ee:transform doc:name="Transform Message" doc:id="ce437556-620e-452a-ac33-328f828c9fa0">
			<ee:variables>
				<ee:set-variable variableName="billingHeader"><![CDATA[%dw 2.0
output application/json
---
{
	idpctxHeaders : if(vars.billerId =='TLG')  
					{
	"Authorization":"Basic bTIzOTgwQGlkcC5hdHQuY29tOmlkcEs4c3J2Y3NBdXRobnAhIQ==",
	"Accept": "application/json",
	"Content-Type": "application/json",
	"Idpctx-linkedwirelessaccnums": vars.ban
}
				else if(vars.billerId =='ENBLR')  
				{
	"Authorization":"Basic bTIzOTgwQGlkcC5hdHQuY29tOmlkcEs4c3J2Y3NBdXRobnAhIQ==",
	"Accept": "application/json",
	"Content-Type": "application/json",
	"Idpctx-linkeduverseaccnums": vars.ban
	
}
				else ''
}]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
	</sub-flow>


</mule>
